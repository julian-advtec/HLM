<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <title>Vista</title>
    <script src="/socket.io/socket.io.js"></script>
    <link rel="stylesheet" href="/tv.css">
</head>

<body>
    <div class="tv-container">
        <div class="columna-izquierda">
            <div class="superior-izquierda">
                <div class="fecha-hora-contenedor">
                    <div class="fecha-hora" id="fechaHora"></div>
                </div>
                <img src="media/Logo1.png" alt="Logo" class="logo-img">
            </div>
            <div id="media-container">
                <img id="media-image" style="display:none;" />
                <video id="media-video" autoplay loop muted style="display:none;"></video>
            </div>
        </div>

        <div class="columna-derecha">
            <div class="datos-container" id="datos-container">
                <div class="titulos-fila">
                    <div class="titulo paciente">Paciente</div>
                    <div class="titulo estado">Estado</div>
                </div>
            </div>
        </div>
    </div>

    <audio id="sonido-actualizacion" src="media/notificacion.mp3" preload="auto"></audio>


    <script>
        const socket = io();
        let pacientes = [];
        let estados = [];
        let rotIndex = 0;
        const mostrar = 9;
        let rotInt;

        socket.on('update', ([d0, d1]) => {
            const map = new Map();
            for (let i = 0; i < d0.length; i++) map.set(d0[i], d1[i]);
            const keys = Array.from(map.keys()).sort();

            pacientes = keys.filter((_, idx) => true);
            estados = pacientes.map((p) => map.get(p));

            const newestP = d0[0];
            const newestE = d1[0];
            const idxN = pacientes.indexOf(newestP);
            if (idxN !== -1) {
                pacientes.splice(idxN, 1);
                estados.splice(idxN, 1);
            }
            rotIndex = 0;

            const prev = document.querySelector('.fila .dato')?.textContent || '';
            const hasChange = prev !== newestP;

            render(newestP, newestE, hasChange);

            clearInterval(rotInt);
            rotInt = setInterval(() => {
                render(newestP, newestE, false);
                rotIndex = (rotIndex + mostrar) % pacientes.length;
            }, 10000);
        });

        function render(p0, e0, playSound) {
            const cont = document.getElementById('datos-container');
            cont.innerHTML = `
    <div class="titulos-fila">
      <div class="titulo paciente">Paciente</div>
      <div class="titulo estado">Estado</div>
    </div>`;

            cont.innerHTML += `
    <div class="fila ${playSound ? 'actualizada' : ''}">
      <div class="dato">${p0}</div><div class="dato">${e0}</div>
    </div>`;

            for (let i = 0; i < mostrar; i++) {
                const idx = (rotIndex + i) % pacientes.length;
                cont.innerHTML += `
      <div class="fila">
        <div class="dato">${pacientes[idx]}</div><div class="dato">${estados[idx]}</div>
      </div>`;
            }

            if (playSound) document.getElementById('sonido-actualizacion').play();
        }

        // multimedia
        let media = [], idx = 0;
        fetch('/media-files')
            .then((r) => r.json())
            .then((f) => {
                media = f;
                if (media.length) {
                    cycleMedia();
                    setInterval(cycleMedia, 30000);
                }
            });

        function cycleMedia() {
            const file = media[idx];
            const url = `/media/${file}`;
            const ext = file.split('.').pop().toLowerCase();
            const img = document.getElementById('media-image');
            const vid = document.getElementById('media-video');

            if (['mp4', 'webm'].includes(ext)) {
                img.style.display = 'none';
                vid.src = url;
                vid.style.display = 'block';
            } else {
                vid.style.display = 'none';
                img.src = url;
                img.style.display = 'block';
            }
            idx = (idx + 1) % media.length;
        }

        // fecha/hora
        function refreshTime() {
            const d = new Date();
            const dia = ['Domingo', 'Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'][d.getDay()];
            const mes = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'][d.getMonth()];
            const dt = `${dia}, ${String(d.getDate()).padStart(2, '0')} de ${mes} de ${d.getFullYear()}`;
            const tm = `${String(d.getHours()).padStart(2, '0')}:${String(d.getMinutes()).padStart(2, '0')}`;
            document.getElementById('fechaHora').innerHTML = `<div>${dt}</div><div>${tm}</div>`;
        }
        setInterval(refreshTime, 1000);
        refreshTime();
    </script>

</body>

</html>